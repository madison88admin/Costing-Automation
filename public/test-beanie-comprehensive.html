<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Beanie Import Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .data-table th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>üß™ Comprehensive Beanie Import Test</h1>
    
    <div class="test-section info">
        <h3>üìÅ File Upload</h3>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.xlsm">
        <p>Upload a beanie Excel file to test the import functionality.</p>
    </div>

    <div id="testResults"></div>

    <script src="js/excelUtils.js"></script>
    <script src="js/beanieImport.js"></script>
    
    <script>
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<h2>üîç Test Results</h2>';
            
            try {
                // Test 1: Class Availability
                resultsDiv.innerHTML += '<div class="test-section"><h3>Test 1: Class Availability</h3>';
                const excelUtilsAvailable = typeof ExcelUtils !== 'undefined';
                const beanieImporterAvailable = typeof TNFBeanieImporter !== 'undefined';
                
                resultsDiv.innerHTML += `<p>ExcelUtils: ${excelUtilsAvailable ? '‚úÖ Available' : '‚ùå Missing'}</p>`;
                resultsDiv.innerHTML += `<p>TNFBeanieImporter: ${beanieImporterAvailable ? '‚úÖ Available' : '‚ùå Missing'}</p>`;
                
                if (!excelUtilsAvailable || !beanieImporterAvailable) {
                    resultsDiv.innerHTML += '<p class="error">‚ùå Required classes not available!</p></div>';
                    return;
                }
                resultsDiv.innerHTML += '<p class="success">‚úÖ All required classes available</p></div>';

                // Test 2: Class Initialization
                resultsDiv.innerHTML += '<div class="test-section"><h3>Test 2: Class Initialization</h3>';
                const excelUtils = new ExcelUtils();
                const beanieImporter = new TNFBeanieImporter();
                resultsDiv.innerHTML += '<p class="success">‚úÖ Classes initialized successfully</p></div>';

                // Test 3: File Reading
                resultsDiv.innerHTML += '<div class="test-section"><h3>Test 3: File Reading</h3>';
                const rawData = await excelUtils.readFileContent(file);
                console.log('Raw data:', rawData);
                
                resultsDiv.innerHTML += `<p>‚úÖ File read successfully</p>`;
                resultsDiv.innerHTML += `<p>Data type: ${typeof rawData}</p>`;
                resultsDiv.innerHTML += `<p>Data length: ${rawData.data ? rawData.data.length : rawData.length}</p>`;
                resultsDiv.innerHTML += `<p>Images found: ${rawData.images ? rawData.images.length : 0}</p></div>`;

                // Test 4: Template Detection
                resultsDiv.innerHTML += '<div class="test-section"><h3>Test 4: Template Detection</h3>';
                const dataToProcess = rawData.data || rawData;
                const dataString = JSON.stringify(dataToProcess).toLowerCase();
                
                const hasYarn = dataString.includes('yarn') || dataString.includes('factory cost breakdown');
                const hasKnitting = dataString.includes('knitting') || dataString.includes('knitting time');
                const hasBeanieStyle = dataString.includes('beanie') || dataString.includes('hat') || dataString.includes('wool');
                const hasYarnMaterials = dataString.includes('uj-f19-011') || dataString.includes('hydd eco') || dataString.includes('merino wool');
                
                resultsDiv.innerHTML += `<p>Has YARN: ${hasYarn ? '‚úÖ' : '‚ùå'}</p>`;
                resultsDiv.innerHTML += `<p>Has KNITTING: ${hasKnitting ? '‚úÖ' : '‚ùå'}</p>`;
                resultsDiv.innerHTML += `<p>Has Beanie Style: ${hasBeanieStyle ? '‚úÖ' : '‚ùå'}</p>`;
                resultsDiv.innerHTML += `<p>Has Yarn Materials: ${hasYarnMaterials ? '‚úÖ' : '‚ùå'}</p>`;
                
                const isBeanieTemplate = hasYarn || hasKnitting || hasBeanieStyle || hasYarnMaterials;
                resultsDiv.innerHTML += `<p class="${isBeanieTemplate ? 'success' : 'error'}">Template Detection: ${isBeanieTemplate ? '‚úÖ Beanie Template Detected' : '‚ùå Not Detected as Beanie'}</p></div>`;

                // Test 5: Data Parsing
                resultsDiv.innerHTML += '<div class="test-section"><h3>Test 5: Data Parsing</h3>';
                const parsedData = beanieImporter.parseExcelData(rawData);
                console.log('Parsed data:', parsedData);
                
                resultsDiv.innerHTML += '<p class="success">‚úÖ Data parsed successfully</p>';
                resultsDiv.innerHTML += `<p>Customer: ${parsedData.customer}</p>`;
                resultsDiv.innerHTML += `<p>Season: ${parsedData.season}</p>`;
                resultsDiv.innerHTML += `<p>Style: ${parsedData.styleNumber}</p>`;
                resultsDiv.innerHTML += `<p>Style Name: ${parsedData.styleName}</p>`;
                resultsDiv.innerHTML += `<p>MOQ: ${parsedData.costedQuantity}</p>`;
                resultsDiv.innerHTML += `<p>Leadtime: ${parsedData.leadtime}</p></div>`;

                // Test 6: Section Data Analysis
                resultsDiv.innerHTML += '<div class="test-section"><h3>Test 6: Section Data Analysis</h3>';
                resultsDiv.innerHTML += `<p>YARN items: ${parsedData.yarn.length}</p>`;
                resultsDiv.innerHTML += `<p>FABRIC items: ${parsedData.fabric.length}</p>`;
                resultsDiv.innerHTML += `<p>TRIM items: ${parsedData.trim.length}</p>`;
                resultsDiv.innerHTML += `<p>KNITTING items: ${parsedData.knitting.length}</p>`;
                resultsDiv.innerHTML += `<p>OPERATIONS items: ${parsedData.operations.length}</p>`;
                resultsDiv.innerHTML += `<p>PACKAGING items: ${parsedData.packaging.length}</p>`;
                resultsDiv.innerHTML += `<p>OVERHEAD items: ${parsedData.overhead.length}</p>`;
                resultsDiv.innerHTML += `<p>Material Total: $${parsedData.totalMaterialCost}</p>`;
                resultsDiv.innerHTML += `<p>Factory Total: $${parsedData.totalFactoryCost}</p></div>`;

                // Test 7: Detailed Data Display
                resultsDiv.innerHTML += '<div class="test-section"><h3>Test 7: Detailed Data Display</h3>';
                
                // YARN Data
                if (parsedData.yarn.length > 0) {
                    resultsDiv.innerHTML += '<h4>YARN Data:</h4><table class="data-table"><tr><th>Material</th><th>Consumption</th><th>Price</th><th>Cost</th></tr>';
                    parsedData.yarn.forEach(item => {
                        resultsDiv.innerHTML += `<tr><td>${item.material}</td><td>${item.consumption}</td><td>$${item.price}</td><td>$${item.cost}</td></tr>`;
                    });
                    resultsDiv.innerHTML += '</table>';
                }

                // FABRIC Data
                if (parsedData.fabric.length > 0) {
                    resultsDiv.innerHTML += '<h4>FABRIC Data:</h4><table class="data-table"><tr><th>Material</th><th>Consumption</th><th>Price</th><th>Cost</th></tr>';
                    parsedData.fabric.forEach(item => {
                        resultsDiv.innerHTML += `<tr><td>${item.material}</td><td>${item.consumption}</td><td>$${item.price}</td><td>$${item.cost}</td></tr>`;
                    });
                    resultsDiv.innerHTML += '</table>';
                }

                // TRIM Data
                if (parsedData.trim.length > 0) {
                    resultsDiv.innerHTML += '<h4>TRIM Data:</h4><table class="data-table"><tr><th>Material</th><th>Consumption</th><th>Price</th><th>Cost</th></tr>';
                    parsedData.trim.forEach(item => {
                        resultsDiv.innerHTML += `<tr><td>${item.material}</td><td>${item.consumption}</td><td>$${item.price}</td><td>$${item.cost}</td></tr>`;
                    });
                    resultsDiv.innerHTML += '</table>';
                }

                // KNITTING Data
                if (parsedData.knitting.length > 0) {
                    resultsDiv.innerHTML += '<h4>KNITTING Data:</h4><table class="data-table"><tr><th>Machine</th><th>Time</th><th>SAH</th><th>Cost</th></tr>';
                    parsedData.knitting.forEach(item => {
                        resultsDiv.innerHTML += `<tr><td>${item.machine}</td><td>${item.time}</td><td>$${item.sah}</td><td>$${item.cost}</td></tr>`;
                    });
                    resultsDiv.innerHTML += '</table>';
                }

                // OPERATIONS Data
                if (parsedData.operations.length > 0) {
                    resultsDiv.innerHTML += '<h4>OPERATIONS Data:</h4><table class="data-table"><tr><th>Operation</th><th>Time</th><th>Cost</th><th>Total</th></tr>';
                    parsedData.operations.forEach(item => {
                        resultsDiv.innerHTML += `<tr><td>${item.operation}</td><td>${item.time}</td><td>$${item.cost}</td><td>$${item.total}</td></tr>`;
                    });
                    resultsDiv.innerHTML += '</table>';
                }

                // PACKAGING Data
                if (parsedData.packaging.length > 0) {
                    resultsDiv.innerHTML += '<h4>PACKAGING Data:</h4><table class="data-table"><tr><th>Type</th><th>Notes</th><th>Cost</th></tr>';
                    parsedData.packaging.forEach(item => {
                        resultsDiv.innerHTML += `<tr><td>${item.type}</td><td>${item.notes}</td><td>$${item.cost}</td></tr>`;
                    });
                    resultsDiv.innerHTML += '</table>';
                }

                // OVERHEAD Data
                if (parsedData.overhead.length > 0) {
                    resultsDiv.innerHTML += '<h4>OVERHEAD Data:</h4><table class="data-table"><tr><th>Type</th><th>Notes</th><th>Cost</th></tr>';
                    parsedData.overhead.forEach(item => {
                        resultsDiv.innerHTML += `<tr><td>${item.type}</td><td>${item.notes}</td><td>$${item.cost}</td></tr>`;
                    });
                    resultsDiv.innerHTML += '</table>';
                }

                resultsDiv.innerHTML += '</div>';

                // Test 8: Raw Data Sample
                resultsDiv.innerHTML += '<div class="test-section"><h3>Test 8: Raw Data Sample (First 10 rows)</h3>';
                resultsDiv.innerHTML += '<pre>' + JSON.stringify(dataToProcess.slice(0, 10), null, 2) + '</pre></div>';

                // Test 9: Complete Parsed Data
                resultsDiv.innerHTML += '<div class="test-section"><h3>Test 9: Complete Parsed Data</h3>';
                resultsDiv.innerHTML += '<pre>' + JSON.stringify(parsedData, null, 2) + '</pre></div>';

            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML += `<div class="test-section error"><h3>‚ùå Error</h3><p>${error.message}</p><pre>${error.stack}</pre></div>`;
            }
        });
    </script>
</body>
</html>
